/*!
 * Name: send-message
 * Id: send-message
 * Version: 1.0.2
 * Description: Send message directly to a user using the chatbot. A plugin for red-bot .io
 * Author: Guido Bellomo (https://github.com/guidone)
 * Repository: https://github.com/guidone/red-bot-send-message
 */
define(["../../../src/components","../../src/components","code-plug","lodash","react","rsuite"],(e,t,n,o,r,s)=>(()=>{var a={529:(e,t,n)=>{"use strict";n.r(t);var o=n(297),r=n.n(o),s=n(222),a=n(804),i=n.n(a),c=n(738);function l(){}const u=function(e,t){var n,o=0,r=1,s={},a=(t=t||{}).maxAttempts||1/0;return s.open=function(){(n=new WebSocket(e,t.protocols||[])).onmessage=t.onmessage||l,n.onopen=function(e){(t.onopen||l)(e),o=0},n.onclose=function(e){1e3===e.code||1001===e.code||1005===e.code||s.reconnect(e),(t.onclose||l)(e)},n.onerror=function(e){e&&"ECONNREFUSED"===e.code?s.reconnect(e):(t.onerror||l)(e)}},s.reconnect=function(e){r&&o++<a?r=setTimeout((function(){(t.onreconnect||l)(e),s.open()}),t.timeout||1e3):(t.onmaximum||l)(e)},s.json=function(e){n.send(JSON.stringify(e))},s.send=function(e){n.send(e)},s.close=function(e,t){r=clearTimeout(r),n.close(e||1e3,t)},s.open(),s},p=new function({url:e,maxAttempts:t=10,timeout:n=5e3}){let o={};const r=(e,...t)=>{null!=o[e]&&o[e].forEach(e=>e(...t))},s=new u(e,{timeout:n,maxAttempts:t,onmessage:e=>{let t;try{t=JSON.parse(e.data)}catch(e){}r("message",t.topic,t.payload)},onreconnect:e=>r("reconnect"),onclose:e=>r("close"),onopen:e=>r("open")}),a={on:(e,t)=>(null==o[e]&&(o[e]=[]),o[e].push(t),a),off:(e,t)=>(null!=o[e]&&(o[e]=o[e].filter(e=>e!==t)),a),close:()=>(o={},s.close(),a),send:e=>(s.send(e),a)};return a}({url:"ws://localhost:"+n(719).wsPort}),d=({reducer:e=(()=>{}),initialState:t={},onMessage:n=(()=>{})}={})=>{const r=(e,t)=>{a({type:"socket.message",topic:e,payload:t}),n(e,t)};(0,o.useEffect)(()=>(p.on("message",r),()=>p.off("message",r)),[]);const[s,a]=(0,o.useReducer)(e,t);return{state:s,dispatch:a,sendMessage:(e,t)=>p.send(JSON.stringify({topic:e,payload:t}))}};let m;null!=window.AppContext?m=window.AppContext:(m=r().createContext({}),window.AppContext=m);const f=m,h=()=>{const{client:e,platforms:t,eventTypes:n,messageTypes:r,activeChatbots:s}=(0,o.useContext)(f);return{client:e,platforms:t,eventTypes:n,messageTypes:r,activeChatbots:s}},g=e=>i().isEmpty(e.first_name)&&i().isEmpty(e.last_name)?i().isEmpty(username)?"Anonymous (id: {id})":e.username:[e.first_name,e.last_name].filter(e=>!i().isEmpty(e)).join(" "),y=({value:e,validation:t,onChange:n=(()=>{}),onSubmit:o=(()=>{})})=>{const{activeChatbots:a}=h();return r().createElement("div",null,r().createElement(s.Form,{fluid:!0,formValue:e,onChange:n,formError:t},r().createElement(s.FlexboxGrid,{justify:"space-between"},r().createElement(s.FlexboxGrid.Item,{colspan:15},r().createElement(s.FormGroup,null,r().createElement(s.ControlLabel,null,"Recipient"),r().createElement(s.FormControl,{name:"recipient",accepter:c.UserAutocomplete,cleanable:!0,onChange:t=>{if(null!=t&&_.isArray(t.chatIds)&&!_.isEmpty(t.chatIds)){const o=t.chatIds.find(e=>((e,t)=>e.some(e=>e.transport===t))(a,e.transport));null!=o&&n({...e,chatId:o.chatId,recipient:t,botNode:a.find(e=>e.transport===o.transport).nodeId})}}}))),r().createElement(s.FlexboxGrid.Item,{colspan:8},r().createElement(s.FormGroup,null,r().createElement(s.ControlLabel,null,"Transport",r().createElement(s.HelpBlock,{tooltip:!0},"Shows only platforms for which the selected users has a valid ",r().createElement("em",null,"chatId"))),r().createElement(s.FormControl,{name:"botNode",accepter:c.SelectTransport,transports:null!=e.recipient?e.recipient.chatIds.map(e=>e.transport):null,disabled:null==e.recipient,onChange:t=>{const o=a.find(e=>e.nodeId===t);if(null!=o&&null!=e.recipient){const r=e.recipient.chatIds.find(e=>e.transport===o.transport);null!=r&&n({...e,chatId:r.chatId,botNode:t})}},block:!0})))),r().createElement(s.FormGroup,{style:{marginTop:"15px"}},r().createElement(s.ControlLabel,null,"Message to send"),r().createElement(s.FormControl,{name:"message",componentClass:"textarea",style:{height:"100%"},onKeyUp:t=>{t.shiftKey&&13===t.keyCode&&(o(),n({...e,message:""}))}}))))},{useModal:v}=c.Modal,b=e=>null!=e.recipient&&null!=e.chatId&&null!=e.botNode&&!i().isEmpty(e.message),{StringType:E,ObjectType:x}=s.Schema.Types,C=(s.Schema.Model({recipient:x().isRequired("Select recipient"),botNode:E().isRequired("Select chatbot platoform"),message:E().isRequired("Enter message for the user")}),({user:e,appearance:t="ghost",transport:n})=>{const{sendMessage:o}=d(),{activeChatbots:a}=h(),{open:c,close:l,validate:u,error:p,disable:m,openWithModel:f,openWith:E}=v({view:y,title:"Send message",labelSubmit:"Send message",size:"sm"});let x,C;if(!i().isEmpty(n)){if(e.chatIds.some(e=>e.transport===n)){const t=a.find(e=>e.transport===n);console.log("chatBot",t,a,n),null!=t&&(x=t.nodeId,C=e.chatIds.find(e=>e.transport===n).chatId)}}return r().createElement(s.Button,{appearance:t,onClick:async()=>{let t={recipient:e,botNode:x,chatId:C,message:""};t=await E(t,b),t&&(o("message.send",t),s.Notification.success({title:"Message sent",description:`Message sent successfully to "${g(t.recipient)}"`}))}},"Contact User")});var w=n(399);const S=r().createContext({});r().Component;function I(){return(I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}var M=n(186);n(470);const{WidgetForm:N,Content:T,Footer:j}=M.WidgetForm;var F;(0,w.plug)("widgets",(F=({sendMessage:e,stats:t})=>{const[n,a]=(0,o.useState)({message:""}),i=!_.isEmpty(n.chatId)&&!_.isEmpty(n.botNode);return r().createElement(M.Panel,{title:"Send Message",className:"widget-send-message"},r().createElement(N,{fluid:!0,formValue:n,onChange:e=>a(e)},r().createElement(T,null,r().createElement(y,{value:n,onChange:e=>a(e)})),r().createElement(j,null,r().createElement(s.FormGroup,null,r().createElement(s.ButtonToolbar,null,r().createElement(s.Button,{appearance:"primary",disabled:!i,onClick:()=>{e("message.send",n),a({...n,message:""})}},"Send Message"),r().createElement("div",{className:"key-hint"},"Shift + Enter to Send"),r().createElement(s.Button,{style:{float:"right"},appearance:"default",onClick:()=>a({botNode:null,recipient:null,chatId:null,message:""})},"Cancel"))))))},e=>r().createElement(S.Consumer,null,({socketListener:t})=>r().createElement(F,I({},e,{sendMessage:null!=t?(e,n)=>t.send(JSON.stringify({topic:e,payload:n})):()=>{}}),e.children))),{x:0,y:0,w:2,h:6,isResizable:!0,id:1}),(0,w.plug)("user-button",C),(0,w.plug)("user-record-buttons",({record:e})=>r().createElement(C,{transport:e.transport,appearance:"primary",user:e.user}),{type:"survey"})},719:e=>{e.exports={wsPort:1942,notificationPort:1943}},155:(e,t,n)=>{var o=n(645);(e.exports=o(!1)).push([e.id,".widget-send-message .rs-form-group{flex:1 0;display:flex;flex-direction:column;flex-wrap:nowrap;justify-content:flex-start;align-content:stretch;align-items:stretch}.widget-send-message .rs-form-group .rs-form-control-wrapper{flex:1 0}.widget-send-message .key-hint{color:#999999;display:inline-block}\n",""])},645:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=function(e,t){var n=e[1]||"",o=e[3];if(!o)return n;if(t&&"function"==typeof btoa){var r=(a=o,i=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(i),"/*# ".concat(c," */")),s=o.sources.map((function(e){return"/*# sourceURL=".concat(o.sourceRoot).concat(e," */")}));return[n].concat(s).concat([r]).join("\n")}var a,i,c;return[n].join("\n")}(t,e);return t[2]?"@media ".concat(t[2],"{").concat(n,"}"):n})).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var o={},r=0;r<this.length;r++){var s=this[r][0];null!=s&&(o[s]=!0)}for(var a=0;a<e.length;a++){var i=e[a];null!=i[0]&&o[i[0]]||(n&&!i[2]?i[2]=n:n&&(i[2]="(".concat(i[2],") and (").concat(n,")")),t.push(i))}},t}},470:(e,t,n)=>{var o=n(155);"string"==typeof o&&(o=[[e.id,o,""]]);var r={insert:"head",singleton:!1};n(379)(o,r);o.locals&&(e.exports=o.locals)},379:(e,t,n)=>{"use strict";var o,r={},s=function(){return void 0===o&&(o=Boolean(window&&document&&document.all&&!window.atob)),o},a=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}();function i(e,t){for(var n=[],o={},r=0;r<e.length;r++){var s=e[r],a=t.base?s[0]+t.base:s[0],i={css:s[1],media:s[2],sourceMap:s[3]};o[a]?o[a].parts.push(i):n.push(o[a]={id:a,parts:[i]})}return n}function c(e,t){for(var n=0;n<e.length;n++){var o=e[n],s=r[o.id],a=0;if(s){for(s.refs++;a<s.parts.length;a++)s.parts[a](o.parts[a]);for(;a<o.parts.length;a++)s.parts.push(g(o.parts[a],t))}else{for(var i=[];a<o.parts.length;a++)i.push(g(o.parts[a],t));r[o.id]={id:o.id,refs:1,parts:i}}}}function l(e){var t=document.createElement("style");if(void 0===e.attributes.nonce){var o=n.nc;o&&(e.attributes.nonce=o)}if(Object.keys(e.attributes).forEach((function(n){t.setAttribute(n,e.attributes[n])})),"function"==typeof e.insert)e.insert(t);else{var r=a(e.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}return t}var u,p=(u=[],function(e,t){return u[e]=t,u.filter(Boolean).join("\n")});function d(e,t,n,o){var r=n?"":o.css;if(e.styleSheet)e.styleSheet.cssText=p(t,r);else{var s=document.createTextNode(r),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(s,a[t]):e.appendChild(s)}}function m(e,t,n){var o=n.css,r=n.media,s=n.sourceMap;if(r&&e.setAttribute("media",r),s&&btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),e.styleSheet)e.styleSheet.cssText=o;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(o))}}var f=null,h=0;function g(e,t){var n,o,r;if(t.singleton){var s=h++;n=f||(f=l(t)),o=d.bind(null,n,s,!1),r=d.bind(null,n,s,!0)}else n=l(t),o=m.bind(null,n,t),r=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return o(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;o(e=t)}else r()}}e.exports=function(e,t){(t=t||{}).attributes="object"==typeof t.attributes?t.attributes:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=s());var n=i(e,t);return c(n,t),function(e){for(var o=[],s=0;s<n.length;s++){var a=n[s],l=r[a.id];l&&(l.refs--,o.push(l))}e&&c(i(e,t),t);for(var u=0;u<o.length;u++){var p=o[u];if(0===p.refs){for(var d=0;d<p.parts.length;d++)p.parts[d]();delete r[p.id]}}}}},738:t=>{"use strict";t.exports=e},186:e=>{"use strict";e.exports=t},399:e=>{"use strict";e.exports=n},804:e=>{"use strict";e.exports=o},297:e=>{"use strict";e.exports=r},222:e=>{"use strict";e.exports=s}},i={};function c(e){if(i[e])return i[e].exports;var t=i[e]={id:e,exports:{}};return a[e](t,t.exports,c),t.exports}return c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var n in t)c.o(t,n)&&!c.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c(529)})());